{% extends "base.html" %}
{% block title %}Messages - Rails Health Interface{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<style>
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #000;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
</div>

<div class="main-content">
    <div class="view-messages-container">
        <div class="view-messages-header">
            <div class="header-with-actions">
                <h1>Messages</h1>
                <div class="header-actions">
                    {% if g.user_role == 'admin' %}
                        <a href="{{ url_for('messages.new_message') }}" class="btn btn-primary btn-sm">New Message</a>
                    {% endif %}
                </div>
            </div>
            <p>View messages for {{ g.organization['name'] }}</p>
        </div>

        <div class="messages-actions">
            <div class="filters-and-pagination">
                {{ form.csrf_token }}
                <div class="filter-by">
                    <select id="endpointFilter" onchange="updateFilters()" class="form-select">
                        <option value="">All Endpoints</option>
                        {% for endpoint in endpoints %}
                            <option value="{{ endpoint.uuid }}" {% if selected_endpoint_uuid == endpoint.uuid %}selected{% endif %}>
                                {{ endpoint.name }}
                            </option>
                        {% endfor %}
                    </select>

                    <select id="typeFilter" onchange="updateFilters()" class="form-select">
                        <option value="">All Types</option>
                        <option value="HL7v2" {% if message_type == 'HL7v2' %}selected{% endif %}>HL7v2</option>
                        <option value="FHIR" {% if message_type == 'FHIR' %}selected{% endif %}>FHIR</option>
                        <option value="Clinical Notes" {% if message_type == 'Clinical Notes' %}selected{% endif %}>Clinical Notes</option>
                        <option value="CCDA" {% if message_type == 'CCDA' %}selected{% endif %}>CCDA</option>
                        <option value="X12" {% if message_type == 'X12' %}selected{% endif %}>X12</option>
                    </select>

                    <span class="page-info">Page {{ page }} of {{ total_pages }}</span>
                    {% if page > 1 %}
                        <a href="javascript:void(0)" onclick="changePage({{ page - 1 }})" class="page-link">Previous</a>
                    {% endif %}
                    {% if page < total_pages %}
                        <a href="javascript:void(0)" onclick="changePage({{ page + 1 }})" class="page-link">Next</a>
                    {% endif %}
                </div>
            </div>
        </div>

        <div id="messages-list">
            {% if grouped_messages %}
                {% for date, messages in grouped_messages.items() %}
                    <h2 class="date-header" id="{{ date }}" data-date="{{ date }}">{{ date }}</h2>
                    <div class="message-group">
                        {% for message in messages %}
                            <div class="card message-card" onclick="navigateToMessage('{{ message['_id'] }}')" data-message-id="{{ message['_id'] }}">
                                <div class="card-header">
                                    <span class="message-time" data-utc="{{ message.timestamp.isoformat() if message.timestamp.isoformat is callable else message.timestamp }}">
                                        {{ message.timestamp.strftime('%I:%M:%S %p') if message.timestamp.strftime is callable else message.timestamp }}
                                    </span>
                                    <span class="messagelist-meta">
                                        <span class="message-stream compact">{{ message.stream_name }}</span>
                                        <span class="message-type compact">{{ message.type }}</span>
                                        {% if not message.parsed %}
                                            <span class="message-status compact">Unparsed</span>
                                        {% endif %}
                                    </span>
                                </div>

                                <div class="card-body">
                                    <pre class="message-content {% if message.truncated %}truncated{% endif %}" data-full-content="{{ message.full_message if message.truncated else '' }}">{{ message.message | replace('\r', '\n') }}</pre>
                                    {% if message.truncated %}
                                        <div class="truncation-notice" onclick="expandContent(this, event)">
                                            Click to view full message
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            {% else %}
                <div id="empty-state" class="alert alert-info">
                    No messages at this point. Messages will appear here once received.
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

function updateFilters() {
    showLoading();
    const endpointFilter = document.getElementById('endpointFilter');
    const typeFilter = document.getElementById('typeFilter');
    
    const url = new URL(window.location.href);
    const params = url.searchParams;
    
    if (endpointFilter.value) {
        params.set('endpoint_uuid', endpointFilter.value);
    } else {
        params.delete('endpoint_uuid');
    }
    
    if (typeFilter.value) {
        params.set('type', typeFilter.value);
    } else {
        params.delete('type');
    }
    
    params.set('page', '1');
    window.location.href = `${url.pathname}?${params.toString()}`;
}

function changePage(page) {
    showLoading();
    const url = new URL(window.location.href);
    const params = url.searchParams;
    params.set('page', page);
    window.location.href = `${url.pathname}?${params.toString()}`;
}

function navigateToMessage(messageId) {
    window.location.href = "{{ url_for('messages.message_detail', message_id='') }}" + messageId;
}

function expandContent(element, event) {
    event.stopPropagation();
    const contentElement = element.previousElementSibling;
    const fullContent = contentElement.dataset.fullContent;
    contentElement.textContent = fullContent;
    contentElement.classList.remove('truncated');
    element.style.display = 'none';
}

function formatDateTime(utcString) {
    return moment.utc(utcString).local().format('hh:mm:ss A');
}

function formatDate(dateString) {
    if (dateString === 'Today' || dateString === 'Yesterday') {
        return dateString;
    }
    return moment(dateString).format('MMMM Do, YYYY');
}

document.addEventListener('DOMContentLoaded', function() {
    // Convert UTC times to local
    document.querySelectorAll('.message-time').forEach(element => {
        const utcTime = element.dataset.utc;
        if (utcTime) {
            element.textContent = formatDateTime(utcTime);
        }
    });

    // Format dates
    document.querySelectorAll('.date-header').forEach(element => {
        const dateString = element.dataset.date;
        if (dateString && dateString !== 'Today' && dateString !== 'Yesterday') {
            element.textContent = formatDate(dateString);
        }
    });

    // Hide loading overlay on page load completion
    hideLoading();
});
</script>
{% endblock %}